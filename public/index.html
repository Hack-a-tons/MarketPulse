<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Pulse Analyst - Full Status Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .header .timestamp { font-size: 0.9em; opacity: 0.7; margin-top: 10px; }
        
        .section { margin-bottom: 25px; }
        .section-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            border-left: 4px solid #10b981;
        }
        
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        
        .card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .card h3 { font-size: 0.9em; opacity: 0.8; margin-bottom: 10px; text-transform: uppercase; }
        .card .value { font-size: 2em; font-weight: bold; }
        .card .subtext { font-size: 0.85em; opacity: 0.7; margin-top: 5px; }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.active { background: #10b981; }
        .status-indicator.inactive { background: #ef4444; }
        
        .service-status {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .service-status:last-child { border-bottom: none; }
        .service-name { flex: 1; font-weight: 600; }
        .service-details { font-size: 0.85em; opacity: 0.7; }
        
        .prediction-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .prediction-card.bullish { border-left-color: #10b981; }
        .prediction-card.bearish { border-left-color: #ef4444; }
        .prediction-card.neutral { border-left-color: #6b7280; }
        .prediction-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .prediction-type { font-size: 1.2em; font-weight: bold; text-transform: uppercase; }
        .prediction-confidence { font-size: 1em; opacity: 0.9; }
        .prediction-reasoning { opacity: 0.85; line-height: 1.4; margin-top: 8px; font-size: 0.9em; }
        .prediction-meta { font-size: 0.8em; opacity: 0.6; margin-top: 8px; }
        
        .data-table {
            width: 100%;
            font-size: 0.9em;
        }
        .data-table td {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .data-table td:first-child {
            opacity: 0.7;
            width: 140px;
        }
        .data-table td:last-child {
            font-weight: 600;
            text-align: right;
        }
        
        .empty-state { text-align: center; padding: 40px 20px; opacity: 0.6; }
        .loading { text-align: center; padding: 20px; opacity: 0.7; }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
        }
        .badge.success { background: rgba(16, 185, 129, 0.3); }
        .badge.warning { background: rgba(245, 158, 11, 0.3); }
        .badge.error { background: rgba(239, 68, 68, 0.3); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Market Pulse Analyst</h1>
            <p>Real-Time AI Financial Predictions ‚Ä¢ Self-Improving Analytics</p>
            <div class="timestamp" id="last-update">Last updated: <span id="update-time">-</span></div>
        </div>

        <!-- Service Status Section -->
        <div class="section">
            <div class="section-title">üöÄ Service Status</div>
            <div class="grid-2">
                <div class="card">
                    <h3>Core Services</h3>
                    <div class="service-status">
                        <div class="service-name">Historical Replay</div>
                        <span class="status-indicator" id="historical-indicator"></span>
                        <span id="historical-status">-</span>
                    </div>
                    <div class="service-status">
                        <div class="service-name">AI Reasoning</div>
                        <span class="status-indicator" id="reasoning-indicator"></span>
                        <span id="reasoning-status">-</span>
                    </div>
                    <div class="service-status">
                        <div class="service-name">Self-Improvement</div>
                        <span class="status-indicator" id="improvement-indicator"></span>
                        <span id="improvement-status">-</span>
                    </div>
                </div>
                <div class="card">
                    <h3>API Health</h3>
                    <div class="value" id="api-health">-</div>
                    <div class="subtext">System operational</div>
                </div>
            </div>
        </div>

        <!-- Data Flow Section -->
        <div class="section">
            <div class="section-title">üìä Data Flow & Buffers</div>
            <div class="grid-4">
                <div class="card">
                    <h3>News Buffer</h3>
                    <div class="value" id="news-buffer">-</div>
                    <div class="subtext">events in memory</div>
                </div>
                <div class="card">
                    <h3>Prices Buffer</h3>
                    <div class="value" id="prices-buffer">-</div>
                    <div class="subtext">events in memory</div>
                </div>
                <div class="card">
                    <h3>Improvement Buffer</h3>
                    <div class="value" id="improvement-buffer">-</div>
                    <div class="subtext">events tracked</div>
                </div>
                <div class="card">
                    <h3>Data Flow</h3>
                    <div class="value" id="data-flow-status">-</div>
                    <div class="subtext">real-time</div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics Section -->
        <div class="section">
            <div class="section-title">üìà Performance Metrics</div>
            <div class="grid-4">
                <div class="card">
                    <h3>Total Predictions</h3>
                    <div class="value" id="total-predictions">-</div>
                    <div class="subtext">generated</div>
                </div>
                <div class="card">
                    <h3>Accuracy</h3>
                    <div class="value" id="accuracy">-%</div>
                    <div class="subtext">historical</div>
                </div>
                <div class="card">
                    <h3>Avg Confidence</h3>
                    <div class="value" id="confidence">-%</div>
                    <div class="subtext">per prediction</div>
                </div>
                <div class="card">
                    <h3>Correct</h3>
                    <div class="value" id="correct-predictions">-</div>
                    <div class="subtext">predictions</div>
                </div>
            </div>
        </div>

        <!-- Prediction Breakdown -->
        <div class="section">
            <div class="section-title">üéØ Prediction Breakdown by Type</div>
            <div class="grid-4">
                <div class="card">
                    <h3>üêÇ Bullish</h3>
                    <table class="data-table">
                        <tr><td>Total:</td><td id="bullish-total">-</td></tr>
                        <tr><td>Correct:</td><td id="bullish-correct">-</td></tr>
                        <tr><td>Accuracy:</td><td id="bullish-accuracy">-%</td></tr>
                    </table>
                </div>
                <div class="card">
                    <h3>üêª Bearish</h3>
                    <table class="data-table">
                        <tr><td>Total:</td><td id="bearish-total">-</td></tr>
                        <tr><td>Correct:</td><td id="bearish-correct">-</td></tr>
                        <tr><td>Accuracy:</td><td id="bearish-accuracy">-%</td></tr>
                    </table>
                </div>
                <div class="card">
                    <h3>‚û°Ô∏è Neutral</h3>
                    <table class="data-table">
                        <tr><td>Total:</td><td id="neutral-total">-</td></tr>
                        <tr><td>Correct:</td><td id="neutral-correct">-</td></tr>
                        <tr><td>Accuracy:</td><td id="neutral-accuracy">-%</td></tr>
                    </table>
                </div>
                <div class="card">
                    <h3>üìä System Info</h3>
                    <table class="data-table">
                        <tr><td>Data Range:</td><td id="data-range">2010-2013</td></tr>
                        <tr><td>Brokers:</td><td id="brokers">Redpanda</td></tr>
                        <tr><td>Refresh:</td><td>15s</td></tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Recent Predictions Section -->
        <div class="section">
            <div class="section-title">üéØ Recent Predictions (Last 10)</div>
            <div class="card">
                <div id="predictions-list">
                    <div class="loading">Loading predictions...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let predictions = [];

        async function fetchAllData() {
            try {
                // Fetch all data in parallel
                const [metricsRes, statusRes, predictionsRes] = await Promise.all([
                    fetch(`${API_URL}/metrics`).catch(() => null),
                    fetch(`${API_URL}/stream/status`).catch(() => null),
                    fetch(`${API_URL}/insights/recent`).catch(() => null)
                ]);

                if (metricsRes) {
                    const metrics = await metricsRes.json();
                    updateMetrics(metrics);
                }

                if (statusRes) {
                    const status = await statusRes.json();
                    updateStatus(status);
                }

                if (predictionsRes) {
                    const data = await predictionsRes.json();
                    if (data.predictions) {
                        predictions = data.predictions.slice(0, 10);
                        renderPredictions();
                    }
                }

                // Update timestamp
                document.getElementById('update-time').textContent = new Date().toLocaleTimeString();
                
            } catch (error) {
                console.error('Failed to fetch data:', error);
            }
        }

        function updateMetrics(data) {
            document.getElementById('total-predictions').textContent = data.totalPredictions;
            document.getElementById('accuracy').textContent = (data.accuracy * 100).toFixed(1) + '%';
            document.getElementById('confidence').textContent = (data.averageConfidence * 100).toFixed(1) + '%';
            document.getElementById('correct-predictions').textContent = data.correctPredictions;
            
            // Prediction types
            document.getElementById('bullish-total').textContent = data.predictionsByType.bullish.total;
            document.getElementById('bullish-correct').textContent = data.predictionsByType.bullish.correct;
            document.getElementById('bullish-accuracy').textContent = (data.predictionsByType.bullish.accuracy * 100).toFixed(1) + '%';
            
            document.getElementById('bearish-total').textContent = data.predictionsByType.bearish.total;
            document.getElementById('bearish-correct').textContent = data.predictionsByType.bearish.correct;
            document.getElementById('bearish-accuracy').textContent = (data.predictionsByType.bearish.accuracy * 100).toFixed(1) + '%';
            
            document.getElementById('neutral-total').textContent = data.predictionsByType.neutral.total;
            document.getElementById('neutral-correct').textContent = data.predictionsByType.neutral.correct;
            document.getElementById('neutral-accuracy').textContent = (data.predictionsByType.neutral.accuracy * 100).toFixed(1) + '%';
        }

        function updateStatus(data) {
            // API Health
            document.getElementById('api-health').innerHTML = '<span class="badge success">‚úì Healthy</span>';
            
            // Historical status
            const histInd = document.getElementById('historical-indicator');
            const histStatus = document.getElementById('historical-status');
            if (data.historical.running) {
                histInd.className = 'status-indicator active';
                histStatus.textContent = 'Active';
            } else {
                histInd.className = 'status-indicator inactive';
                histStatus.textContent = 'Inactive';
            }
            
            // Reasoning status
            const reasonInd = document.getElementById('reasoning-indicator');
            const reasonStatus = document.getElementById('reasoning-status');
            if (data.reasoning.running) {
                reasonInd.className = 'status-indicator active';
                reasonStatus.textContent = 'Active';
            } else {
                reasonInd.className = 'status-indicator inactive';
                reasonStatus.textContent = 'Inactive';
            }
            
            // Improvement status
            const impInd = document.getElementById('improvement-indicator');
            const impStatus = document.getElementById('improvement-status');
            if (data.improvement.running) {
                impInd.className = 'status-indicator active';
                impStatus.textContent = 'Active';
            } else {
                impInd.className = 'status-indicator inactive';
                impStatus.textContent = 'Inactive';
            }
            
            // Buffers
            document.getElementById('news-buffer').textContent = data.reasoning.buffers.news;
            document.getElementById('prices-buffer').textContent = data.reasoning.buffers.prices;
            document.getElementById('improvement-buffer').textContent = data.improvement.bufferSize || 0;
            
            // Data flow status
            const hasData = data.reasoning.buffers.news > 0 || data.reasoning.buffers.prices > 0;
            document.getElementById('data-flow-status').innerHTML = hasData ? 
                '<span class="badge success">‚úì Flowing</span>' : 
                '<span class="badge warning">‚ö† Waiting</span>';
            
            // System info
            if (data.config) {
                document.getElementById('data-range').textContent = `${data.config.dataRange.start} to ${data.config.dataRange.end}`;
                document.getElementById('brokers').textContent = data.config.redpandaBrokers.join(', ');
            }
        }

        function renderPredictions() {
            const container = document.getElementById('predictions-list');
            
            if (predictions.length === 0) {
                container.innerHTML = '<div class="empty-state">No predictions yet. Services are warming up...</div>';
                return;
            }

            container.innerHTML = predictions.map(p => `
                <div class="prediction-card ${p.prediction}">
                    <div class="prediction-header">
                        <span class="prediction-type">${p.prediction === 'bullish' ? 'üêÇ' : p.prediction === 'bearish' ? 'üêª' : '‚û°Ô∏è'} ${p.prediction}</span>
                        <span class="prediction-confidence">${(p.confidence * 100).toFixed(1)}% confidence</span>
                    </div>
                    <div class="prediction-reasoning">${p.reasoning.substring(0, 180)}${p.reasoning.length > 180 ? '...' : ''}</div>
                    <div class="prediction-meta">
                        ${p.symbol ? `${p.symbol} ‚Ä¢ ` : ''}
                        Horizon: ${p.timeHorizon} ‚Ä¢ 
                        ${new Date(p.timestamp).toLocaleString()}
                    </div>
                </div>
            `).join('');
        }

        // Initial load
        fetchAllData();

        // Refresh every 15 seconds
        setInterval(fetchAllData, 15000);
    </script>
</body>
</html>
